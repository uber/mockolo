name: Release

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-release:
    name: Build on ${{ matrix.destination.os }}
    runs-on: ${{ matrix.destination.os }}
    strategy:
      matrix:
        destination:
          - { name: "ubuntu-x86_64", os: ubuntu-20.04 }
          - { name: "ubuntu-aarch64", os: ubuntu-20.04, container: "arm64v8/ubuntu:latest" }
          - { name: "macos-universal", os: macos-12 }
    container: ${{ matrix.destination.container }}
    steps:
    - uses: swift-actions/setup-swift@v2
      with:
        swift-version: "5.10"
    - uses: actions/checkout@v4
    - name: Create the binary
      run: ./install-script.sh -s . -t mockolo -d . -o mockolo.${{ matrix.destination.name }}.tar.gz
    - name: Upload the binary
      uses: actions/upload-artifact@v4
      with:
        name: mockolo.${{ matrix.destination.name }}
        path: mockolo.${{ matrix.destination.name }}.tar.gz

  check-portability:
    needs: build-release
    name: TestRun on ${{ matrix.destination.os }}
    runs-on: ${{ matrix.destination.os }}
    strategy:
      matrix:
        destination:
          - { name: "ubuntu-x86_64", os: ubuntu-22.04 }
          - { name: "ubuntu-x86_64", os: ubuntu-20.04 }
          - { name: "ubuntu-aarch64", os: ubuntu-20.04, container: "arm64v8/ubuntu:latest" }
          - { name: "macos-universal", os: macos-14 }
          - { name: "macos-universal", os: macos-13 }
          - { name: "macos-universal", os: macos-12 }
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: mockolo.${{ matrix.destination.name }}
    - name: Unpack the binary
      run: tar -xvf mockolo.${{ matrix.destination.name }}.tar.gz
    - name: Run the binary
      run: ./mockolo --version

  deploy-binary:
    if: ${{ github.event_name == 'release' }}
    needs: check-portability
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
    - name: Deploy the binary
      uses: softprops/action-gh-release@v2
      with:
        files: |
          mockolo.ubuntu-x86_64.tar.gz
          mockolo.ubuntu-aarch64.tar.gz
          mockolo.macos-universal.tar.gz
